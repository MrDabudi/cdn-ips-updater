# –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IP-–∞–¥—Ä–µ—Å–æ–≤ CDN

–ì–∏–±–∫–∏–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π bash-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ IP-–∞–¥—Ä–µ—Å–æ–≤ CDN-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (CloudFlare –∏ Gcore) –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üåê **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö CDN**: CloudFlare (IPv4 + IPv6) –∏ Gcore
- üîÑ **–£–º–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç HAProxy, Fail2ban, Nginx –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IP
- üìù **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ journald –¥–ª—è –ø—Ä–æ—Å—Ç–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- üéØ **–ì–∏–±–∫–∏–π CLI**: –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–ª–∏ —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö CDN-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- ‚öôÔ∏è **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ—Å—Ç—å**: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —á–µ—Ä–µ–∑ –æ–ø—Ü–∏–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
- üîí **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –ù–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- üì¶ **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ CDN-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –∏–ª–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- `curl` - –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–æ–≤ IP
- `jq` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) - –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON (–ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è grep)
- `systemctl` - –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏
- `logger` - –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ journald (–æ–±—ã—á–Ω–æ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –°–∫–∞—á–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç
wget https://raw.githubusercontent.com/MrDabudi/cdn-ips-updater/main/update_cdn_ips.sh

# –°–¥–µ–ª–∞–π—Ç–µ –µ–≥–æ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x update_cdn_ips.sh

# –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
sudo mv update_cdn_ips.sh /opt/scripts/
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å

```bash
./update_cdn_ips.sh [–ö–û–ú–ê–ù–î–ê] [–û–ü–¶–ò–ò]
```

### –ö–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `all` | –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ CDN IP –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| `cloudflare` | –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ CloudFlare IP |
| `gcore` | –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ Gcore IP |
| `reload` | –¢–æ–ª—å–∫–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã (–±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IP) |
| `help` | –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É |

### –û–ø—Ü–∏–∏

| –û–ø—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|-------|----------|--------------|
| `--dir=PATH` | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é | `/opt/cdn-ips/cdn_ips` |
| `--services=LIST` | –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é | `haproxy,fail2ban` |
| `--cf-file=NAME` | –ò–º—è —Ñ–∞–π–ª–∞ CloudFlare | `cloudflare_ips.lst` |
| `--gcore-file=NAME` | –ò–º—è —Ñ–∞–π–ª–∞ Gcore | `gcore_ips.lst` |

## –ü—Ä–∏–º–µ—Ä—ã

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```bash
# –û–±–Ω–æ–≤–∏—Ç—å –≤—Å—ë —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
./update_cdn_ips.sh

# –¢–æ –∂–µ —Å–∞–º–æ–µ (—è–≤–Ω–æ)
./update_cdn_ips.sh all

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
./update_cdn_ips.sh help
```

### –í—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
# –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ CloudFlare IP
./update_cdn_ips.sh cloudflare

# –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ Gcore IP
./update_cdn_ips.sh gcore

# –¢–æ–ª—å–∫–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã (–±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IP)
./update_cdn_ips.sh reload
```

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```bash
# –û–±–Ω–æ–≤–∏—Ç—å CloudFlare —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π
./update_cdn_ips.sh cloudflare --dir=/custom/path

# –û–±–Ω–æ–≤–∏—Ç—å –≤—Å—ë —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
./update_cdn_ips.sh all --services=nginx,haproxy,apache2

# –û–±–Ω–æ–≤–∏—Ç—å Gcore —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞
./update_cdn_ips.sh gcore --gcore-file=custom_gcore.lst

# –ù–µ—Å–∫–æ–ª—å–∫–æ –æ–ø—Ü–∏–π –≤–º–µ—Å—Ç–µ
./update_cdn_ips.sh cloudflare --dir=/tmp/cdn --cf-file=cf_ips.txt --services=nginx
```

### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø—Ä–∏–º–µ—Ä—ã

```bash
# –û–±–Ω–æ–≤–∏—Ç—å CloudFlare –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ nginx
./update_cdn_ips.sh cloudflare --services=nginx

# –û–±–Ω–æ–≤–∏—Ç—å Gcore –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
./update_cdn_ips.sh gcore --services=""

# –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ CDN IP, –Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ fail2ban
./update_cdn_ips.sh all --services=fail2ban
```

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Cron

–î–æ–±–∞–≤—å—Ç–µ –≤ crontab –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:

```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å crontab
crontab -e

# –ü—Ä–∏–º–µ—Ä—ã:

# –û–±–Ω–æ–≤–ª—è—Ç—å –≤—Å—ë –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3 —á–∞—Å–∞ –Ω–æ—á–∏
0 3 * * * /opt/scripts/update_cdn_ips.sh all

# –û–±–Ω–æ–≤–ª—è—Ç—å CloudFlare –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
0 */6 * * * /opt/scripts/update_cdn_ips.sh cloudflare

# –û–±–Ω–æ–≤–ª—è—Ç—å Gcore –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
0 */12 * * * /opt/scripts/update_cdn_ips.sh gcore

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –∫–∞–∂–¥—ã–π —á–∞—Å (–±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IP)
0 * * * * /opt/scripts/update_cdn_ips.sh reload
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ journald —Å —Ç–µ–≥–æ–º `cdn-ips-updater`.

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
journalctl -t cdn-ips-updater -f

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
journalctl -t cdn-ips-updater --since "1 hour ago"

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
journalctl -t cdn-ips-updater --since today

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 50 –∑–∞–ø–∏—Å–µ–π
journalctl -t cdn-ips-updater -n 50
```

## –í—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã

–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã –≤ —Ü–µ–ª–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:

- `cloudflare_ips.lst` - –¥–∏–∞–ø–∞–∑–æ–Ω—ã CloudFlare IPv4 –∏ IPv6 (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)
- `gcore_ips.lst` - –¥–∏–∞–ø–∞–∑–æ–Ω—ã Gcore IPv4 –∏ IPv6 (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)

–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–∞:
```
173.245.48.0/20
103.21.244.0/22
2606:4700::/32
```

## –ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è HAProxy

```haproxy
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CloudFlare IP –¥–ª—è ACL
acl from_cloudflare src -f /opt/cdn-ips/cloudflare_ips.lst
http-request set-header X-Forwarded-For %[src] if from_cloudflare
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Fail2ban

```ini
[cloudflare-whitelist]
enabled = true
filter = cloudflare
action = iptables-allports[name=cloudflare]
logpath = /var/log/nginx/access.log
ignoreip = file:/opt/cdn-ips/cloudflare_ips.lst
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx

```nginx
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π IP –æ—Ç CloudFlare
set_real_ip_from 173.245.48.0/20;
set_real_ip_from 103.21.244.0/22;
# ... –≤–∫–ª—é—á–∏—Ç—å —Ñ–∞–π–ª, —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç–æ–º
include /opt/cdn-ips/cloudflare_ips.lst;
real_ip_header CF-Connecting-IP;
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –°–∫—Ä–∏–ø—Ç –Ω–µ –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å IP

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∞–≤–∏–ª–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å CloudFlare
curl -I https://www.cloudflare.com/ips-v4

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Gcore
curl -I https://api.gcore.com/cdn/public-ip-list
```

### –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:
```bash
systemctl status haproxy
systemctl status fail2ban
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É —Å–∫—Ä–∏–ø—Ç–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:
```bash
sudo mkdir -p /opt/cdn-ips/cdn_ips
sudo chmod 755 /opt/cdn-ips/cdn_ips
```

## –£—á–∞—Å—Ç–∏–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è –ª—é–±—ã–µ –≤–∫–ª–∞–¥—ã –≤ –ø—Ä–æ–µ–∫—Ç:

- –°–æ–æ–±—â–∞–π—Ç–µ –æ–± –æ—à–∏–±–∫–∞—Ö
- –ü—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ pull request'—ã
- –î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö CDN-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã

- [CloudFlare IP Ranges](https://www.cloudflare.com/ips/)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Gcore CDN](https://gcore.com/docs/cdn)

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ [–ª–æ–≥–∏](#–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
2. –ò–∑—É—á–∏—Ç–µ —Ä–∞–∑–¥–µ–ª [—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫](#—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ-–Ω–µ–ø–æ–ª–∞–¥–æ–∫)
3. –°–æ–∑–¥–∞–π—Ç–µ issue –Ω–∞ GitHub

---

‚≠ê –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –æ–∫–∞–∑–∞–ª—Å—è –ø–æ–ª–µ–∑–Ω—ã–º, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –∑–≤–µ–∑–¥—É –Ω–∞ GitHub!
